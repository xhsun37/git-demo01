/*
   -- RemoteXY Control for RC Car --
   Generated by RemoteXY editor for ESP32 BLE control.
   Requires RemoteXY library 3.1.13+ (http://remotexy.com/en/library/).
   Connect via RemoteXY app (http://remoxy.com/en/download/):
     - Android 4.15.01+
     - iOS 1.12.1+
   Licensed under GNU Lesser General Public License v2.1+.
*/

#define REMOTEXY_MODE__ESP32CORE_BLE // 定義 RemoteXY 為 ESP32 BLE 模式
#include <BLEDevice.h>
#define REMOTEXY_BLUETOOTH_NAME "RemoteXY" // 藍牙設備名稱
#include <RemoteXY.h>

#pragma pack(push, 1) // RemoteXY GUI 配置
uint8_t RemoteXY_CONF[] = { // 47 bytes
  255,3,0,1,0,40,0,19,0,0,0,0,31,1,106,200,1,1,3,0,
  5,24,69,60,60,0,2,26,31,1,41,168,24,24,0,36,31,0,70,15,
  7,18,18,6,26,135,0
};

struct { // 控制介面變數
  int8_t joystick_x; // 搖桿 X 軸：-100 到 100
  int8_t joystick_y; // 搖桿 Y 軸：-100 到 100
  uint8_t button_stop; // 停止按鈕：按下為 1，鬆開為 0
  uint8_t connect_flag; // 連線狀態：連線為 1，斷線為 0
} RemoteXY;
#pragma pack(pop)

#define IN1 14 // L298N 控制腳位
#define IN2 27
#define IN3 26
#define IN4 25

void setup() { // 初始化函數
  RemoteXY_Init(); // 初始化 RemoteXY
  pinMode(IN1, OUTPUT); // 設定腳位為輸出
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);
  stopMotors(); // 初始停止馬達
  Serial.begin(115200); // 初始化序列埠
}

void loop() { // 主迴圈函數
  RemoteXY_Handler(); // 處理 RemoteXY 通信
  if (RemoteXY.button_stop == 1) { // 檢查停止按鈕
    stopMotors();
    Serial.println("停止按鈕被按下");
    return;
  }
  int speed = map(max(abs(RemoteXY.joystick_y), abs(RemoteXY.joystick_x)), 0, 100, 0, 255); // 搖桿值映射為速度
  if (RemoteXY.joystick_y > 20) { // 前進
    goForward(speed);
    Serial.println("前進");
  } else if (RemoteXY.joystick_y < -20) { // 後退
    goBackward(speed);
    Serial.println("後退");
  } else if (RemoteXY.joystick_x < -20) { // 左轉
    turnLeft(speed);
    Serial.println("左轉");
  } else if (RemoteXY.joystick_x > 20) { // 右轉
    turnRight(speed);
    Serial.println("右轉");
  } else { // 停止
    stopMotors();
    Serial.println("停止");
  }
}